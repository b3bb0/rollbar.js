<html>
  <head>
    <script>
      window.onerror = function() {
        console.log('orig onerror', arguments);
      };
      (function(w, d) {
        if (w.Rollbar) {
          return w.Rollbar;
        }
        var Rollbar = function(parentShim) {
          this.shimId = ++Rollbar.shimCounter;
          this.notifier = null;
          this.parentShim = parentShim;
        };

        Rollbar.shimCounter = 0;

        var methods = ['log', 'debug', 'info', 'warning', 'error', 'critical', 'configure', 'scope', 'uncaughtError'];
        for (var i = 0; i < methods.length; ++i) {
          Rollbar.prototype[methods[i]] = function(method) {
            return function() {
              if (this.notifier) {
                this.notifier[method].apply(this, arguments);
              } else {
                var shim = this;
                if (method === 'scope') {
                  shim = new Rollbar(this);
                }
                var data = {shim: shim, method: method, args: arguments, ts: new Date()};
                w.RollbarShimQueue.push(data);

                if (method === 'scope') {
                  return shim;
                }
              }
            };
          }(methods[i]);
        }

        // Create the client and set the onerror handler
        var client = new Rollbar();
        var old = w.onerror;
        w.onerror = function() {
          client.uncaughtError.apply(client, arguments); 
          old && old.apply(w, arguments);
        };

        // Create the main rollbar script loader
        var loader = function() {
          var s = d.createElement("script");
          var f = d.getElementsByTagName("script")[0];
          s.src = "../dist/rollbar.js";
          s.async = true;
          f.parentNode.insertBefore(s, f);
        };

        // Have the window load up the script ASAP
        if (w.addEventListener) {
          w.addEventListener("load", loader, false);
        } else { 
          w.attachEvent("onload", loader);
        }

        // Expose Rollbar globally
        w.Rollbar = client;

        // Create the global shim queue
        w.RollbarShimQueue = [];

        // Finally, return the new client
        return client;
      })(window, document);
    </script>

    <script>
      // Configure Rollbar, overwrites any previous configuration
      Rollbar.configure({accessToken: 'ACCESS_TOKEN', environment: 'staging'});

      // Log simple message at 'info' level
      Rollbar.info('Hello world');

      // Log info message with custom data
      Rollbar.info('Hello world', {customVar: 333});

      // Log error level exception
      var err;
      try {
        foo();
      } catch (e) {
        err = e;
        Rollbar.error('foo didn\'t work', err);
      }

      // Log error level exception with custom data
      Rollbar.error('foo didn\'t work', err, {customVal: 333});

      // Set person data and log warning with custom data (with chaining)
      Rollbar.scope({personId: 12345}).warning('User did something crazy', {crazyId: 'asdf'});

      // Log warning level exception with custom data and callback
      Rollbar.warning('User pressed the red button!', {buttonId: 'red'}, function(err, uuid) {
        if (err) {
          console.error('Error reporting message to Rollbar: ' + err);
        } else {
          console.log('Rollbar item url: https://rollbar.com/item/uuid/?uuid=' + uuid);
        }
      });
    </script>
  </head>
  <body>
    Hello world
  </body>
</html>
